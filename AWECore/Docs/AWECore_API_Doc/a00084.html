<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWECore 8.D.6 API Document: LinuxAppMulti.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWECore 8.D.6 API Document
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">LinuxAppMulti.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Examples</p>
<div class="fragment"><div class="line"><span class="comment">/****************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *        Simple Multi-Instance AWECore Linux Application</span></div>
<div class="line"><span class="comment"> *        -----------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> ****************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *    Description:    Sample app to show basic usage of AWECore&#39;s multi-instance features</span></div>
<div class="line"><span class="comment"> *         A multi-instance AWECore integration with simulated real-time audio on Linux. </span></div>
<div class="line"><span class="comment"> *        Includes an ethernet/TCPIP tuning interface to connect to AWE Server on port 15092</span></div>
<div class="line"><span class="comment"> *        Each instance of AWECore shares a tuning packet buffer and shared heap.</span></div>
<div class="line"><span class="comment"> *        AWE Instance 1 is connected to ethernet interface and will internally signal Instance 2 to process packets when needed.</span></div>
<div class="line"><span class="comment"> *        AWE Instance 2 polls continuously for packets in its own thread. </span></div>
<div class="line"><span class="comment"> *        AWE Instance 2 is triggered to pump by AWE Instance 1, which is in turn triggered by simulated real-time audio callback.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *    Copyright: (c) 2023    DSP Concepts, Inc. All rights reserved.</span></div>
<div class="line"><span class="comment"> *                                    3235 Kifer Road</span></div>
<div class="line"><span class="comment"> *                                    Santa Clara, CA 95054-1527</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> ***************************************************************************/</span></div>
<div class="line"><span class="preprocessor">#define _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span> </div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;semaphore.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;semaphore.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00038.html">AWECore.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00050.html">ProxyIDs.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00041.html">AWECoreUtils.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;TargetInfo.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>ConfigParameters</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> coreSpeed;</div>
<div class="line">    <span class="keywordtype">float</span> profileSpeed;</div>
<div class="line">    <span class="keywordtype">float</span> sampleRate;</div>
<div class="line">    UINT32 fundamentalBlockSize;</div>
<div class="line">    UINT32 inChannels;</div>
<div class="line">    UINT32 outChannels;</div>
<div class="line">    UINT32 profileStatus;</div>
<div class="line">    INT32 tuningPort;</div>
<div class="line">} ConfigParameters;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Config parameters to control from app arguments</span></div>
<div class="line"><span class="keyword">static</span> ConfigParameters configParams; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// AWB with 2 instances used in layout</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> loopback_dualcore_startAudio_InitCommands[] = {</div>
<div class="line">    0x0002000c, 0x00060006, 0x473b8000, 0x40008002, 0x00000020, 0x00000000, 0x00060006, 0x473b8000,</div>
<div class="line">    0x40008002, 0x00000020, 0x00000000, 0x00060006, 0x473b8000, 0x40008002, 0x00000020, 0x00000000,</div>
<div class="line">    0x00060106, 0x473b8000, 0x40008002, 0x00000020, 0x00000000, 0x00040007, 0x00000001, 0x00000001,</div>
<div class="line">    0x00040007, 0x00000002, 0x00000002, 0x0009000f, 0xbeef0866, 0x00000101, 0x00000002, 0x00000001,</div>
<div class="line">    0x00000003, 0x00000001, 0x00000000, 0x0008000f, 0xbeef1037, 0x00000001, 0x00000002, 0x00000003,</div>
<div class="line">    0x00000000, 0x00000001, 0x0007000f, 0xbeef086d, 0x00000001, 0x00000001, 0x00000003, 0x00000000,</div>
<div class="line">    0x00080065, 0x0000680a, 0x00000000, 0x00000400, 0x00000002, 0xc0a00000, 0x40a00000, 0x0008010f,</div>
<div class="line">    0xbeef1038, 0x00000100, 0x00000002, 0x00000001, 0x00000000, 0x00000000, 0x0008010f, 0xbeef1037,</div>
<div class="line">    0x00000001, 0x00000002, 0x00000001, 0x00000000, 0x00000001, 0x0007010f, 0xbeef086d, 0x00000001,</div>
<div class="line">    0x00000001, 0x00000001, 0x00000000, 0x00080165, 0x0000480a, 0x00000000, 0x00000400, 0x00000002,</div>
<div class="line">    0xc0a00000, 0x40a00000, 0x0008000f, 0xbeef1038, 0x00000100, 0x00000002, 0x00000003, 0x00000000,</div>
<div class="line">    0x00000000, 0x0007000f, 0xbeef086d, 0x00000001, 0x00000001, 0x00000003, 0x00000000, 0x00080065,</div>
<div class="line">    0x0000880a, 0x00000000, 0x00000400, 0x00000002, 0xc0a00000, 0x40a00000, 0x0009000f, 0xbeef0866,</div>
<div class="line">    0x00000101, 0x00000002, 0x00000003, 0x00000002, 0x00000000, 0x00000001, 0x00040010, 0x00000006,</div>
<div class="line">    0x00000001, 0x000a002f, 0x0000000a, 0x00000000, 0x00000004, 0x00000005, 0x00000006, 0x00000007,</div>
<div class="line">    0x00000008, 0x00000009, 0x00040110, 0x00000003, 0x00000001, 0x0007012f, 0x00000005, 0x00000000,</div>
<div class="line">    0x00000002, 0x00000003, 0x00000004, 0x0006013c, 0x00002008, 0x00000008, 0x00000100, 0x00000000,</div>
<div class="line">    0x0006003c, 0x00007008, 0x0000008c, 0x00000100, 0x00000000, 0x0002001b, 0x00000000,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> loopback_dualcore_startAudio_InitCommands_Len = <span class="keyword">sizeof</span>(loopback_dualcore_startAudio_InitCommands) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>); <span class="comment">// 143 words</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Don&#39;t load AWB on startup, to avoid compatibility issues with prebuilt C array above</span></div>
<div class="line"><span class="preprocessor">#define LOAD_MULTICORE_AWB 0</span></div>
<div class="line"><span class="preprocessor">#define NUM_INSTANCES 3</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Table of AWE Instances used for multi-instance applications</span></div>
<div class="line"><a name="_a0"></a><a class="code" href="a00071.html">AWEInstance</a> *pInstances[NUM_INSTANCES];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> IOPinDescriptor aweInputPin;</div>
<div class="line"><span class="keyword">static</span> IOPinDescriptor aweOutputPin;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// LISTOFCLASSOBJECTS comes from ModuleList.h .. shared by both instances</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">void</span>* module_descriptor_table[] =</div>
<div class="line">{</div>
<div class="line">    LISTOFCLASSOBJECTS</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate shared heap buffer, used by all instances</span></div>
<div class="line">UINT32 sharedHeap[SHARED_HEAP_SIZE_LINUX];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Universal packet buffer used by all AWE instances</span></div>
<div class="line">UINT32 tuningPacketBuffer[MAX_COMMAND_BUFFER_LEN];</div>
<div class="line">UINT32 tuningReplyBuffer[MAX_COMMAND_BUFFER_LEN];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Audio buffers</span></div>
<div class="line">UINT32 *audioInputBuffer;</div>
<div class="line">UINT32 *audioOutputBuffer;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Global thread handles and mutexes</span></div>
<div class="line">pthread_t packetProcessHandles[NUM_INSTANCES];</div>
<div class="line">pthread_t audioCallbackThreadHandle;</div>
<div class="line">pthread_t audioPumpAllThreadHandles[NUM_INSTANCES];</div>
<div class="line">sem_t pumpSems[NUM_INSTANCES];</div>
<div class="line"> </div>
<div class="line">INT32 exitAudioCallbackThread;</div>
<div class="line">INT32 audioStarted;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> callbackCnt;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> pumpCnts[NUM_INSTANCES];</div>
<div class="line">INT32 quiet;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Tuning parameters</span></div>
<div class="line"><span class="keywordtype">int</span> sockfd, newsockfd;</div>
<div class="line"><span class="keywordtype">int</span> exitTuning = 0;</div>
<div class="line"><span class="preprocessor">#define DEFAULT_TUNING_PORT             (15092)</span></div>
<div class="line"><span class="preprocessor">#define DEFAULT_BLOCK_SIZE              (128)   // Reasonable block size to simulate real time callbacks!!!</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// increase priority levels for AWE threads</span></div>
<div class="line"><span class="comment">// Audio callback functions must be highest priority to avoid</span></div>
<div class="line"><span class="comment">// missing real time requirements. Pump is right after,</span></div>
<div class="line"><span class="comment">// followed by tuning interface where actions can be performed</span></div>
<div class="line"><span class="comment">// in the background.</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_CALLBACK_PRIO     (99)</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_PUMP_PRIO         (AUDIO_CALLBACK_PRIO - 1)</span></div>
<div class="line"><span class="preprocessor">#define TUNING_THREAD_PRIO      (AUDIO_PUMP_PRIO - NUM_INSTANCES)</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> error(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg)</div>
<div class="line">{</div>
<div class="line">    perror(msg);</div>
<div class="line">    exit(1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> sig_handler(<span class="keywordtype">int</span> signo)</div>
<div class="line">{    </div>
<div class="line">    <span class="keywordflow">if</span> (signo == SIGINT)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Cought user termination signal</span></div>
<div class="line">        exitTuning = 1;</div>
<div class="line">        shutdown(newsockfd, SHUT_RDWR);</div>
<div class="line">        close(newsockfd);    </div>
<div class="line">        shutdown(sockfd, SHUT_RDWR);</div>
<div class="line">        close(sockfd);    </div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Exiting LinuxAppMulti\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *program)</div>
<div class="line">{</div>
<div class="line">    printf(</div>
<div class="line">        <span class="stringliteral">&quot;Usage: %s [args]\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -sr:sampling_rate           value in Hz, default 48KHz\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -pf:profile_frequency       value in Hz, default 10MHz\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -cf:cpu_frequency           value in Hz, default 1GHz\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -profStatus:N               set profiling status (0 - disable, 1 - enable(default), 2 - enable module level only, 3 - enable top level only)\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -bsize:N                    default 32, Audio block size for the system\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -inchans:N                  default 2, number of input channels\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -outchans:N                 default 2, number of output channels\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -tport:N                    default 15092, port number for socket interface. User can choose between 15002 - 15098\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;       -quiet                      print only error messages\n&quot;</span>        </div>
<div class="line">        <span class="stringliteral">&quot;       -h, -help                   show this message\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;This program exercises the AWECore library with 2 AWEInstances.\n&quot;</span>,</div>
<div class="line">        program);</div>
<div class="line">        exit(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* tuningPacketThread(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Tuning packets can be recieved and processed here. Another implementation </span></div>
<div class="line"><span class="comment">        may choose to process the packet in another thread.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    (void) arg;</div>
<div class="line">    socklen_t clilen;</div>
<div class="line">    <span class="keyword">struct </span>sockaddr_in serv_addr, cli_addr;</div>
<div class="line">    INT32 schedPolicy, ret;</div>
<div class="line">    <span class="keyword">struct </span>sched_param schedParam;     </div>
<div class="line">    <span class="keywordtype">int</span> socketOption;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set this thread to run at real time priority</span></div>
<div class="line">    pthread_t currentHandle = pthread_self();</div>
<div class="line">    schedParam.sched_priority = TUNING_THREAD_PRIO;</div>
<div class="line">    schedPolicy = SCHED_RR;</div>
<div class="line">    ret = pthread_setschedparam(currentHandle, schedPolicy, &amp;schedParam);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to increase priority of tuning thread with error: %s \nTry running with sudo\n&quot;</span>, strerror(ret));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span> threadNameBuffer[16]; </div>
<div class="line">    snprintf(threadNameBuffer, 16, <span class="stringliteral">&quot;awe0_packet&quot;</span>);</div>
<div class="line">    ret = pthread_setname_np(packetProcessHandles[0], threadNameBuffer);</div>
<div class="line">    <span class="keywordflow">if</span> (ret)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to set thread name to %s\n&quot;</span>, threadNameBuffer);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    sockfd = socket(AF_INET, SOCK_STREAM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (sockfd &lt; 0) </div>
<div class="line">    {</div>
<div class="line">        error(<span class="stringliteral">&quot;ERROR opening socket&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set the socket connection option to immediately allow reuse of port upon losing connection</span></div>
<div class="line">    socketOption = 1;</div>
<div class="line">    setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;socketOption, <span class="keyword">sizeof</span>(socketOption));    </div>
<div class="line">    </div>
<div class="line">    bzero((<span class="keywordtype">char</span> *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr));</div>
<div class="line"> </div>
<div class="line">    serv_addr.sin_family = AF_INET;</div>
<div class="line">    serv_addr.sin_addr.s_addr = INADDR_ANY;</div>
<div class="line">    serv_addr.sin_port = htons(configParams.tuningPort);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (bind(sockfd, (<span class="keyword">struct</span> sockaddr *) &amp;serv_addr,</div>
<div class="line">              <span class="keyword">sizeof</span>(serv_addr)) &lt; 0) </div>
<div class="line">    {</div>
<div class="line">        error(<span class="stringliteral">&quot;ERROR on binding&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (!exitTuning)</div>
<div class="line">    {</div>
<div class="line">        listen(sockfd,5);</div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Listening for connection on port %d\n&quot;</span>, configParams.tuningPort);</div>
<div class="line">        }</div>
<div class="line">        clilen = <span class="keyword">sizeof</span>(cli_addr);</div>
<div class="line">        newsockfd = accept(sockfd, </div>
<div class="line">                     (<span class="keyword">struct</span> sockaddr *) &amp;cli_addr, </div>
<div class="line">                     &amp;clilen);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (newsockfd &lt; 0) </div>
<div class="line">        {</div>
<div class="line">            error(<span class="stringliteral">&quot;ERROR on accept&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Enter a tuning loop. This will be in a separate thread from audio processing */</span></div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {        </div>
<div class="line">            printf( <span class="stringliteral">&quot;Found connection!\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Setup sleep time for 5 ms</span></div>
<div class="line">        <span class="keyword">struct </span>timespec ts;</div>
<div class="line">        ts.tv_nsec = 5000000;</div>
<div class="line">        ts.tv_sec = 0;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span>(1)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> plen;</div>
<div class="line">            ssize_t readBytes, n;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Only read from socket if multi-instance packet API isn&#39;t waiting on a response from another AWE instance */</span></div>
<div class="line">            <span class="keywordflow">if</span> (ret != <a name="a1"></a><a class="code" href="a00047.html#ab4b51c99066bf10a1db260e1a53ec146">E_MULTI_PACKET_WAITING</a>)</div>
<div class="line">            {</div>
<div class="line">                readBytes = read(newsockfd, tuningPacketBuffer, MAX_COMMAND_BUFFER_LEN * <span class="keyword">sizeof</span>(tuningPacketBuffer[0]));</div>
<div class="line">                <span class="keywordflow">if</span> (readBytes == 0)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// No message to read</span></div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (readBytes &lt; 0) </div>
<div class="line">                {</div>
<div class="line">                    error(<span class="stringliteral">&quot;ERROR reading from socket&quot;</span>);</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// May not have received the whole message. Read again if not</span></div>
<div class="line">                plen = <a name="a2"></a><a class="code" href="a00041.html#ac6baaae3417f9751055e0dba298a80a5">PACKET_LENGTH_BYTES</a>(tuningPacketBuffer);</div>
<div class="line">                <span class="keywordflow">while</span> (readBytes &lt; plen)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">//printf(&quot;Didn&#39;t read the entire packet! readBytes = %d, plen = %d\nReading again\n&quot;, readBytes, plen);</span></div>
<div class="line">                    n = read(newsockfd,&amp;((<span class="keywordtype">char</span>*)tuningPacketBuffer)[readBytes], MAX_COMMAND_BUFFER_LEN * <span class="keyword">sizeof</span>(tuningPacketBuffer[0]));</div>
<div class="line">                    <span class="keywordflow">if</span> (n == 0)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; 0) </div>
<div class="line">                    {</div>
<div class="line">                        error(<span class="stringliteral">&quot;ERROR reading from socket&quot;</span>);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> </div>
<div class="line">                    {</div>
<div class="line">                        readBytes += n;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Process the received message (may involve signaling instance 2 to process packet)</span></div>
<div class="line">            ret = <a name="a3"></a><a class="code" href="a00044.html#a2d5438a02407ecb829c58faa4b2610f8">awe_packetProcessMulti</a>(pInstances[0], TRUE); </div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Send reply packet back to PC if multi-instance packet API is not waiting on a response packet</span></div>
<div class="line">            <span class="keywordflow">if</span> (ret != <a class="code" href="a00047.html#ab4b51c99066bf10a1db260e1a53ec146">E_MULTI_PACKET_WAITING</a>)</div>
<div class="line">            {</div>
<div class="line">                plen = <a name="a4"></a><a class="code" href="a00041.html#a55fe32a688d8aa99d686274bccb540f9">PACKET_LENGTH_WORDS</a>(tuningReplyBuffer);</div>
<div class="line"> </div>
<div class="line">                n = write(newsockfd, tuningReplyBuffer, plen * <span class="keyword">sizeof</span>(tuningReplyBuffer[0]));</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">if</span> (n &lt; plen)</div>
<div class="line">                {</div>
<div class="line">                    error(<span class="stringliteral">&quot;ERROR writing to socket&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Sleep while waiting for other instances to process packets</span></div>
<div class="line">                clock_nanosleep(CLOCK_MONOTONIC, 0, &amp;ts, NULL);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* packetProcessThread(<span class="keywordtype">void</span> * args)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="a00071.html">AWEInstance</a> * pAWE = (<a class="code" href="a00071.html">AWEInstance</a> *) args;</div>
<div class="line">    INT32 instanceId = pAWE-&gt;<a name="a5"></a><a class="code" href="a00071.html#ae9532b2425c362e352c24f11c8edd02a">instanceId</a>;</div>
<div class="line">    INT32 schedPolicy, ret;</div>
<div class="line">    <span class="keyword">struct </span>sched_param schedParam;</div>
<div class="line">    <span class="keyword">struct </span>timespec ts;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set this thread to run at real time priority</span></div>
<div class="line">    pthread_t currentHandle = pthread_self();</div>
<div class="line">    schedParam.sched_priority = TUNING_THREAD_PRIO - instanceId;</div>
<div class="line">    schedPolicy = SCHED_RR;</div>
<div class="line">    ret = pthread_setschedparam(currentHandle, schedPolicy, &amp;schedParam);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to increase priority of tuning thread %d with error: %s \nTry running with sudo\n&quot;</span>, instanceId, strerror(ret));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span> threadNameBuffer[16]; </div>
<div class="line">    snprintf(threadNameBuffer, 16, <span class="stringliteral">&quot;awe%d_packet&quot;</span>, instanceId);</div>
<div class="line">    pthread_setname_np(packetProcessHandles[instanceId], threadNameBuffer);</div>
<div class="line">    <span class="keywordflow">if</span> (ret)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to set thread name to %s\n&quot;</span>, threadNameBuffer);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Starting instance %d packet process thread\n&quot;</span>, instanceId);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Setup sleep time for 5 ms</span></div>
<div class="line">    ts.tv_nsec = 5000000;</div>
<div class="line">    ts.tv_sec = 0;</div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// constantly poll packet process thread to respond to packets received on instance 1</span></div>
<div class="line">        <a class="code" href="a00044.html#a2d5438a02407ecb829c58faa4b2610f8">awe_packetProcessMulti</a>(pAWE, FALSE);</div>
<div class="line">        clock_nanosleep(CLOCK_MONOTONIC, 0, &amp;ts, NULL);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* aweuser_pumpAudio(<span class="keywordtype">void</span> * args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Represents the callback function from the audio framework</span></div>
<div class="line">    INT32 pumpMask;</div>
<div class="line">    INT32 schedPolicy, ret, targetPriority;</div>
<div class="line">    <span class="keyword">struct </span>sched_param schedParam;</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="a00071.html">AWEInstance</a> * pAWE = (<a class="code" href="a00071.html">AWEInstance</a> *) args;</div>
<div class="line">    INT32 instanceId = pAWE-&gt;<a class="code" href="a00071.html#ae9532b2425c362e352c24f11c8edd02a">instanceId</a>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set this thread to run at real time priority</span></div>
<div class="line">    pthread_t currentHandle = pthread_self();</div>
<div class="line">    targetPriority = AUDIO_PUMP_PRIO - instanceId;</div>
<div class="line">    schedParam.sched_priority = targetPriority;</div>
<div class="line">    schedPolicy = SCHED_FIFO;</div>
<div class="line">    pthread_setschedparam(currentHandle, schedPolicy, &amp;schedParam);</div>
<div class="line">    <span class="keywordtype">int</span> policy;</div>
<div class="line">    pthread_getschedparam(currentHandle, &amp;policy, &amp;schedParam);</div>
<div class="line">    <span class="keywordflow">if</span> ((SCHED_FIFO != policy) || (schedParam.sched_priority != targetPriority))</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Warning: Failed to increase priority of audio simulation thread to %d\nTry running as root\n&quot;</span>, targetPriority);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">char</span> threadNameBuffer[16]; </div>
<div class="line">    snprintf(threadNameBuffer, 16, <span class="stringliteral">&quot;awe%d_pump&quot;</span>, instanceId);    </div>
<div class="line">    ret = pthread_setname_np(audioPumpAllThreadHandles[instanceId], threadNameBuffer);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Starting pump thread for instance %d\n&quot;</span>, instanceId);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> (1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Wait for signal to run thread</span></div>
<div class="line">        sem_wait(&amp;pumpSems[instanceId]);</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="a00044.html#aa14f1cef3b4579e3d0aac85fe9a7c9cd">awe_layoutIsValid</a>(pAWE) &amp;&amp; <a name="a7"></a><a class="code" href="a00044.html#af4b5a0f5f9f869fb6e7ebeccfdd8fae3">awe_audioIsStarted</a>(pAWE))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (instanceId == 0)</div>
<div class="line">            {   </div>
<div class="line">                <span class="comment">// Import new samples only for layout 0</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; configParams.inChannels ; i++)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Import new samples</span></div>
<div class="line">                    ret = <a name="a8"></a><a class="code" href="a00044.html#a9e4bb98b017a47c1c1cad5e897c6390b">awe_audioImportSamples</a>(pAWE, &amp;audioInputBuffer[i], configParams.inChannels, i, <a name="a9"></a><a class="code" href="a00056.html#aa902d2fa9a96414950faa1cd33d02af9a8267a816f0e5d656471666befe047de3">Sample32bit</a>);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret)</div>
<div class="line">                    {</div>
<div class="line">                        printf(<span class="stringliteral">&quot;Error: awe_audioImportSamples() failed, channel = %d, error = %d\n&quot;</span>, i, ret);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Pump any required sublayouts</span></div>
<div class="line">            pumpMask = <a name="a10"></a><a class="code" href="a00044.html#ab8882c4641a4461678acfab526f61478">awe_audioGetPumpMask</a>(pAWE);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (instanceId == 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Instance 1 has to signal all other instances to run</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ix = 1; ix &lt; NUM_INSTANCES; ix++)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (<a name="a11"></a><a class="code" href="a00044.html#acb3df1d67abff15df3f81accf213a379">awe_audioIsReadyToPumpMulti</a>(pAWE, ix))</div>
<div class="line">                    {</div>
<div class="line">                        sem_post(&amp;pumpSems[ix]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Each sublayout should be pumped in its own thread, </span></div>
<div class="line">            <span class="comment">// but running all sequentially here for simplicity. This does not</span></div>
<div class="line">            <span class="comment">// propertly handle sublayouts at higher clockDividers, as all sublayouts</span></div>
<div class="line">            <span class="comment">// must complete at layout input blockrate.</span></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; NUM_THREADS; j++)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (pumpMask &amp; (1U &lt;&lt; j))</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Pump the sublayout. </span></div>
<div class="line">                    ret |= <a name="a12"></a><a class="code" href="a00044.html#a3e08c72e3bf11627e4fd87a99ebb6419">awe_audioPump</a>(pAWE, j);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">// Do deferred processing if needed</span></div>
<div class="line">            <span class="keywordflow">if</span> (ret &gt; 0) </div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// This could be done in a loop until ret == 0, but doing one per fundamental period </span></div>
<div class="line">                <span class="comment">// is more conservative at the cost of potentially taking longer to update a module parameter</span></div>
<div class="line">                ret = <a name="a13"></a><a class="code" href="a00044.html#a2f78d537ec23c5222d4533de286f6349">awe_deferredSetCall</a>(pAWE);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (instanceId == 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Export samples</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; configParams.outChannels ; i++)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Import new samples</span></div>
<div class="line">                    ret = <a name="a14"></a><a class="code" href="a00044.html#ab2a5f4c7d4228495a3af02cad79b2ee7">awe_audioExportSamples</a>(pAWE, &amp;audioOutputBuffer[i], configParams.outChannels, i, <a class="code" href="a00056.html#aa902d2fa9a96414950faa1cd33d02af9a8267a816f0e5d656471666befe047de3">Sample32bit</a>);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret)</div>
<div class="line">                    {  </div>
<div class="line">                        printf(<span class="stringliteral">&quot;Error: awe_audioExportSamples() failed, channel = %d, error = %d\n&quot;</span>, i, ret);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            pumpCnts[instanceId]++;            </div>
<div class="line">        } <span class="comment">// if layout valid</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* audioCallbackSimulator(<span class="keywordtype">void</span> * args)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Simple real-time audio simulator. Would be ALSA, PortAudio, etc callback</span></div>
<div class="line">    <span class="comment">// Attempts to get accurate pumping rate on average by correction for overshoot</span></div>
<div class="line">    <span class="comment">// caused by timer resolution</span></div>
<div class="line">    <span class="keyword">struct </span>timespec ts;</div>
<div class="line">    <span class="keyword">struct </span>timespec ts_tmp;</div>
<div class="line">    <span class="keywordtype">long</span> time_nsec;</div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> accumulated_time1;</div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> accumulated_time2;</div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> overshoot = 0.0; </div>
<div class="line">    </div>
<div class="line">    (void) args;</div>
<div class="line">    INT32 schedPolicy, ret;</div>
<div class="line">    <span class="keyword">struct </span>sched_param schedParam;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Setup sleep time for fundamental blocksize</span></div>
<div class="line">    time_nsec = (long) ((<span class="keywordtype">float</span>)1000000000L * ((float)configParams.fundamentalBlockSize / configParams.sampleRate));</div>
<div class="line">    ts.tv_sec = 0;</div>
<div class="line">    ts_tmp.tv_sec = 0;</div>
<div class="line">    ts_tmp.tv_nsec = 0;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set this thread to run at real time priority</span></div>
<div class="line">    pthread_t currentHandle = pthread_self();</div>
<div class="line">    schedParam.sched_priority = AUDIO_CALLBACK_PRIO;</div>
<div class="line">    schedPolicy = SCHED_FIFO;</div>
<div class="line">    pthread_setschedparam(currentHandle, schedPolicy, &amp;schedParam);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> policy;</div>
<div class="line">    pthread_getschedparam(currentHandle, &amp;policy, &amp;schedParam);</div>
<div class="line">    <span class="keywordflow">if</span> ((SCHED_FIFO != policy) || (schedParam.sched_priority != AUDIO_CALLBACK_PRIO)) </div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Warning: Failed to increase priority of audio simulation thread to %d\nTry running as root\n&quot;</span>, AUDIO_CALLBACK_PRIO);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">char</span> threadNameBuffer[32]; </div>
<div class="line">    snprintf(threadNameBuffer, 32, <span class="stringliteral">&quot;awe_callback&quot;</span>);</div>
<div class="line">    ret = pthread_setname_np(audioCallbackThreadHandle, threadNameBuffer);</div>
<div class="line">    <span class="keywordflow">if</span> (ret)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to set thread name to %s\n&quot;</span>, threadNameBuffer);</div>
<div class="line">    }    </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (!exitAudioCallbackThread)</div>
<div class="line">    {</div>
<div class="line">        callbackCnt++;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Kick off the primary audio thread</span></div>
<div class="line">        sem_post(&amp;pumpSems[0]);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Subtract any overshoot from the last sleep to balance block rate</span></div>
<div class="line">        <span class="comment">// Will there be a chance of overshoot &gt; time_nsec ???</span></div>
<div class="line">        ts.tv_nsec = time_nsec - overshoot;</div>
<div class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;ts_tmp);</div>
<div class="line">        accumulated_time1 = ((<span class="keywordtype">long</span> long)ts_tmp.tv_sec*1000000000) + ts_tmp.tv_nsec + time_nsec - overshoot;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span>(1)</div>
<div class="line">        {</div>
<div class="line">            clock_nanosleep(CLOCK_MONOTONIC, 0, &amp;ts, NULL);</div>
<div class="line">            clock_gettime(CLOCK_MONOTONIC, &amp;ts_tmp);</div>
<div class="line">            accumulated_time2 = ((<span class="keywordtype">long</span> long)ts_tmp.tv_sec*1000000000) + ts_tmp.tv_nsec;</div>
<div class="line">            <span class="keywordflow">if</span> (accumulated_time2 &gt;= accumulated_time1)</div>
<div class="line">            {</div>
<div class="line">                overshoot = (accumulated_time2 - accumulated_time1);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                ts.tv_nsec = (long)(accumulated_time1 - accumulated_time2);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">INT32 aweuser_audioStart(<a class="code" href="a00071.html">AWEInstance</a> *pAWE)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Audio start callback. Can be used to start audio stream from audio framework.</span></div>
<div class="line">    <span class="comment">// Could be ALSA, Pulse, Jack, Portaudio, etc. </span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Kick off real-time audio simulation thread, instance 0 is the driver</span></div>
<div class="line">    <span class="keywordflow">if</span> (!audioStarted &amp;&amp; pAWE-&gt;<a class="code" href="a00071.html#ae9532b2425c362e352c24f11c8edd02a">instanceId</a> == 0)</div>
<div class="line">    {</div>
<div class="line">        exitAudioCallbackThread = 0;</div>
<div class="line">        callbackCnt = 0;</div>
<div class="line">        memset(pumpCnts, 0, <span class="keyword">sizeof</span>(pumpCnts));</div>
<div class="line"> </div>
<div class="line">        INT32 ret = pthread_create(&amp;audioCallbackThreadHandle, NULL, audioCallbackSimulator, NULL);     </div>
<div class="line">        <span class="keywordflow">if</span> (ret)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Error creating audio callback simulator! ret = %d\n&quot;</span>, ret);</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        audioStarted = 1;</div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Audio Started\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }        </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">INT32 aweuser_audioStop(<a class="code" href="a00071.html">AWEInstance</a> *pAWE)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Audio stop callback. Can be used to clean up audio stream.</span></div>
<div class="line">    <span class="keywordflow">if</span> (audioStarted)</div>
<div class="line">    {</div>
<div class="line">        INT32 ret;</div>
<div class="line">        exitAudioCallbackThread = 1;</div>
<div class="line">        ret = pthread_join(audioCallbackThreadHandle, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Failed to join audio simulator thread: ret = %d\n&quot;</span>, ret);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {</div>
<div class="line">            UINT32 avgCycles;</div>
<div class="line">            <span class="keyword">const</span> FLOAT32 clockRatios = configParams.coreSpeed / configParams.profileSpeed;</div>
<div class="line">            printf(<span class="stringliteral">&quot;\nAudio Stopped\n&quot;</span>);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">            {</div>
<div class="line">                ret = <a name="a15"></a><a class="code" href="a00044.html#a7b94cd700b8db15b98c0386192efd50f">awe_getAverageLayoutCycles</a>(pInstances[i], 0, &amp;avgCycles);</div>
<div class="line">                <span class="keywordflow">if</span> (ret != <a name="a16"></a><a class="code" href="a00047.html#ad1a31c5316d5f51ca5c1c4fb2b9b1958">E_SUCCESS</a>)</div>
<div class="line">                {</div>
<div class="line">                    avgCycles = 0;</div>
<div class="line">                }</div>
<div class="line">                printf(<span class="stringliteral">&quot;-- Pumped instance %d %llu times, average cycles per pump: %f\n&quot;</span>, i, pumpCnts[i], </div>
<div class="line">                    (avgCycles &gt;&gt; 8) * clockRatios);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        audioStarted = 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> InitializeAWEInstance(<a class="code" href="a00071.html">AWEInstance</a> * awePtr, INT32 instanceId)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">    UINT32 module_descriptor_table_size = <span class="keyword">sizeof</span>(module_descriptor_table) / <span class="keyword">sizeof</span>(module_descriptor_table[0]);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set pointers to universal AWE packet buffer, same buffer for all instances</span></div>
<div class="line">    awePtr-&gt;<a name="a17"></a><a class="code" href="a00071.html#a5b01cf1b8e8a280bbf3f7f948f54f74b">pPacketBuffer</a> = tuningPacketBuffer;</div>
<div class="line">    awePtr-&gt;<a name="a18"></a><a class="code" href="a00071.html#a2af7c6f45a9ea471031950713dc8a58d">pReplyBuffer</a> = tuningReplyBuffer;</div>
<div class="line">    awePtr-&gt;<a name="a19"></a><a class="code" href="a00071.html#ab625b95dee9149bb1eae3ff92eb53b2f">packetBufferSize</a> = MAX_COMMAND_BUFFER_LEN;</div>
<div class="line">    </div>
<div class="line">    awePtr-&gt;<a name="a20"></a><a class="code" href="a00071.html#af1ff1dcacc3c9cc819b6f956ce79cf3f">pModuleDescriptorTable</a> = module_descriptor_table;</div>
<div class="line">    awePtr-&gt;<a name="a21"></a><a class="code" href="a00071.html#aeb7e2d3cb5d35f9704d968e489c4c441">numModules</a> = module_descriptor_table_size;</div>
<div class="line"> </div>
<div class="line">    awePtr-&gt;<a name="a22"></a><a class="code" href="a00071.html#a440826c61772cf568281332f76871954">numThreads</a> = NUM_THREADS;</div>
<div class="line">    awePtr-&gt;<a name="a23"></a><a class="code" href="a00071.html#aa69aad6195a0f3fec1e6affcd613b027">sampleRate</a> = configParams.sampleRate;</div>
<div class="line">    awePtr-&gt;<a name="a24"></a><a class="code" href="a00071.html#a9cb2adbcdae20532abb84c0c7fc9e318">fundamentalBlockSize</a> = configParams.fundamentalBlockSize;</div>
<div class="line">    awePtr-&gt;<a name="a25"></a><a class="code" href="a00071.html#ae210f0425f22de96f25bf36ab14ba88c">pFlashFileSystem</a> = HAS_FLASHFILESYSTEM;</div>
<div class="line"> </div>
<div class="line">    awePtr-&gt;<a name="a26"></a><a class="code" href="a00071.html#af4a2203871c4688499180f87429e3d76">fastHeapASize</a> = FASTA_HEAP_SIZE_LINUX;</div>
<div class="line">    awePtr-&gt;<a name="a27"></a><a class="code" href="a00071.html#acc5c50b58381b039a7e2044863ba9444">fastHeapBSize</a> = FASTB_HEAP_SIZE_LINUX;</div>
<div class="line">    awePtr-&gt;<a name="a28"></a><a class="code" href="a00071.html#a8c37e96abcd68926d0ac6959b5dc6cd6">slowHeapSize</a> = SLOW_HEAP_SIZE_LINUX;</div>
<div class="line">    awePtr-&gt;<a name="a29"></a><a class="code" href="a00071.html#ae0ea51f58db3b9d03151fde8bb03574f">sharedHeapSize</a> = SHARED_HEAP_SIZE_LINUX;</div>
<div class="line">    </div>
<div class="line">    awePtr-&gt;<a name="a30"></a><a class="code" href="a00071.html#afbeef773c955bfda318ca134fa40f03b">pFastHeapA</a> = malloc(FASTA_HEAP_SIZE_LINUX * <span class="keyword">sizeof</span>(UINT32));</div>
<div class="line">    awePtr-&gt;<a name="a31"></a><a class="code" href="a00071.html#a3357ea97cbc3a98ffff830eb586dca32">pFastHeapB</a> = malloc(FASTB_HEAP_SIZE_LINUX * <span class="keyword">sizeof</span>(UINT32));</div>
<div class="line">    awePtr-&gt;<a name="a32"></a><a class="code" href="a00071.html#aa19cf0c2c0ae9511cfe3625d3f2df53b">pSlowHeap</a> = malloc(SLOW_HEAP_SIZE_LINUX * <span class="keyword">sizeof</span>(UINT32));</div>
<div class="line">    awePtr-&gt;<a name="a33"></a><a class="code" href="a00071.html#ab8f2f163ae5569e16a4a99070037741c">pSharedHeap</a> = sharedHeap;</div>
<div class="line"> </div>
<div class="line">    awePtr-&gt;<a name="a34"></a><a class="code" href="a00071.html#ae805783687d93c111f2803d6b07c7d05">coreSpeed</a> = configParams.coreSpeed;</div>
<div class="line">    awePtr-&gt;<a name="a35"></a><a class="code" href="a00071.html#a1c40d7469bcb0c0b30c35d27ab7a9fb2">profileSpeed</a> = configParams.profileSpeed;</div>
<div class="line">    <span class="comment">// Give each instance a unique name</span></div>
<div class="line">    awePtr-&gt;<a name="a36"></a><a class="code" href="a00071.html#a147fe9ce7dca2b6bcc3d86ac9b36f025">pName</a> = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * 8);</div>
<div class="line">    sprintf((<span class="keywordtype">char</span>*)awePtr-&gt;<a class="code" href="a00071.html#a147fe9ce7dca2b6bcc3d86ac9b36f025">pName</a>, <span class="stringliteral">&quot;awe#%d&quot;</span>, instanceId);</div>
<div class="line">    </div>
<div class="line">    awePtr-&gt;<a class="code" href="a00071.html#ae9532b2425c362e352c24f11c8edd02a">instanceId</a> = instanceId;</div>
<div class="line">    <span class="comment">// Need to set this value for all instances</span></div>
<div class="line">    awePtr-&gt;<a name="a37"></a><a class="code" href="a00071.html#ade74518284efdb8fa9e28ea53c832b94">numProcessingInstances</a> = NUM_INSTANCES;</div>
<div class="line">    awePtr-&gt;<a name="a38"></a><a class="code" href="a00071.html#a6422edfaf98b2c9d2b8e4d61503862c3">cbAudioStart</a> = aweuser_audioStart;</div>
<div class="line">    awePtr-&gt;<a name="a39"></a><a class="code" href="a00071.html#a689ac9ee605eeb9517ccfaa15679e71a">cbAudioStop</a> = aweuser_audioStop;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (instanceId == 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> i, j;</div>
<div class="line">        <span class="comment">// Only instance 0 deals with inputs and outputs,</span></div>
<div class="line">        <span class="comment">// so only this instance needs pins and audio start/stop</span></div>
<div class="line">        awePtr-&gt;<a name="a40"></a><a class="code" href="a00071.html#a04b44d860ec9755b807ff1c1e5769fbd">pInputPin</a> = &amp;aweInputPin;</div>
<div class="line">        awePtr-&gt;<a name="a41"></a><a class="code" href="a00071.html#a5612d068da07ac3f25cf34126b0c3ee1">pOutputPin</a> = &amp;aweOutputPin;        </div>
<div class="line">        ret = <a name="a42"></a><a class="code" href="a00044.html#a20d7c4aef91a7b0e190881efa67d15a7">awe_initPin</a>(&amp;aweInputPin, configParams.inChannels, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;awe_initPin inputPin failed on AWEInstance 0\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        ret = <a class="code" href="a00044.html#a20d7c4aef91a7b0e190881efa67d15a7">awe_initPin</a>(&amp;aweOutputPin, configParams.outChannels, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;awe_initPin outputPin failed on AWEInstance 0\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef PI</span></div>
<div class="line"><span class="preprocessor">#define PI 3.141592653589793</span></div>
<div class="line"><span class="preprocessor">#endif </span></div>
<div class="line">        <span class="comment">// Fill audio input buffers with full scale sin waves</span></div>
<div class="line">        <span class="keywordtype">float</span> blockRate = configParams.sampleRate / configParams.fundamentalBlockSize;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; configParams.fundamentalBlockSize; i++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (j = 0; j &lt; configParams.inChannels; j++) </div>
<div class="line">            {</div>
<div class="line">                audioInputBuffer[i * configParams.inChannels + j] = <a name="a43"></a><a class="code" href="a00041.html#a45fc7eb0345371558e5a7c64a49d37dc">float_to_fract32</a>(sinf(2.f * PI * </div>
<div class="line">                    (j + 1) * blockRate * (i / configParams.sampleRate)));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a44"></a><a class="code" href="a00044.html#ae4e7e278a5a4794714190415899d8022">awe_init</a>(awePtr);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0) </div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;awe_init on instance %d failed with %d\n&quot;</span>, instanceId, ret);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Initialized instance %d\n&quot;</span>, instanceId);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span>* argv[] )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    configParams.coreSpeed = CORE_SPEED;</div>
<div class="line">    configParams.profileSpeed = PROFILE_SPEED;</div>
<div class="line">    configParams.sampleRate = SAMPLE_RATE;</div>
<div class="line">    configParams.fundamentalBlockSize = DEFAULT_BLOCK_SIZE;</div>
<div class="line">    configParams.inChannels = NUM_INPUT_CHANNELS;</div>
<div class="line">    configParams.outChannels = NUM_OUTPUT_CHANNELS;</div>
<div class="line">    configParams.tuningPort = DEFAULT_TUNING_PORT;</div>
<div class="line">    configParams.profileStatus = 1;</div>
<div class="line">    quiet = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Handle user inputs</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *arg = argv[i];</div>
<div class="line">    </div>
<div class="line">        <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-profStatus:&quot;</span>, 12))</div>
<div class="line">        {</div>
<div class="line">            configParams.profileStatus = atoi(arg + 12);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-bsize:&quot;</span>, 7))</div>
<div class="line">        {</div>
<div class="line">            configParams.fundamentalBlockSize = atoi(arg + 7);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-inchans:&quot;</span>, 9))</div>
<div class="line">        {</div>
<div class="line">            configParams.inChannels = atoi(arg + 9);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-outchans:&quot;</span>, 10))</div>
<div class="line">        {</div>
<div class="line">            configParams.outChannels = atoi(arg + 10);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(0 == strncmp(arg, <span class="stringliteral">&quot;-sr:&quot;</span>, 4))</div>
<div class="line">        {</div>
<div class="line">            configParams.sampleRate = (float)atof(arg + 4);</div>
<div class="line">        }           </div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-cf:&quot;</span>, 4))</div>
<div class="line">        {</div>
<div class="line">            configParams.coreSpeed = (float)atof(arg + 4);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-pf:&quot;</span>, 4))</div>
<div class="line">        {</div>
<div class="line">            configParams.profileSpeed = (float)atof(arg + 4);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-tport:&quot;</span>, 7))</div>
<div class="line">        {</div>
<div class="line">            configParams.tuningPort = atoi(arg + 7);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(arg, <span class="stringliteral">&quot;-quiet&quot;</span>, 6))</div>
<div class="line">        {</div>
<div class="line">            quiet = 1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((0 == strncmp(arg, <span class="stringliteral">&quot;-help&quot;</span>, 5)) || (0 == strncmp(arg, <span class="stringliteral">&quot;-h&quot;</span>, 2)))</div>
<div class="line">        {</div>
<div class="line">            usage(argv[0]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (!quiet)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nAWECore initialised with the following parameters\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-cf:            %f Hz\n&quot;</span>, configParams.coreSpeed);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-pf:            %f Hz\n&quot;</span>, configParams.profileSpeed);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-sr:            %f Hz\n&quot;</span>, configParams.sampleRate);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-bsize:         %u\n&quot;</span>, configParams.fundamentalBlockSize);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-inchans:       %u\n&quot;</span>, configParams.inChannels);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-outchans:      %u\n&quot;</span>, configParams.outChannels);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-tport:         %d\n&quot;</span>, configParams.tuningPort);</div>
<div class="line">        printf(<span class="stringliteral">&quot;-profStatus:    %u\n&quot;</span>, configParams.profileStatus);</div>
<div class="line">    }    </div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Setup signal handler to kill sockets</span></div>
<div class="line">    <span class="keywordflow">if</span> (signal(SIGINT, sig_handler) == SIG_ERR)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Can&#39;t catch SIGINT (%d)\n&quot;</span>, SIGINT);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Allocate audio buffers used by instance 0</span></div>
<div class="line">    audioInputBuffer  = malloc(configParams.inChannels  * configParams.fundamentalBlockSize * <span class="keyword">sizeof</span>(UINT32));</div>
<div class="line">    audioOutputBuffer = malloc(configParams.outChannels * configParams.fundamentalBlockSize * <span class="keyword">sizeof</span>(UINT32));</div>
<div class="line">        </div>
<div class="line">    <span class="comment">// Allocate the instances needed and then initialize</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">    {</div>
<div class="line">        pInstances[i] = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="a00071.html">AWEInstance</a>));</div>
<div class="line">        InitializeAWEInstance(pInstances[i], i);</div>
<div class="line">        <a name="a45"></a><a class="code" href="a00044.html#ac6a2989f2e5575d96ce9cd8baab99207">awe_setProfilingStatus</a>(pInstances[i], configParams.profileStatus);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Register instance table, required when using multiple AWE instances on a single-core (application dependent on Linux)</span></div>
<div class="line">    <a name="a46"></a><a class="code" href="a00044.html#a5fd23e753a1360b0ec5112102ea5536f">awe_setInstancesInfo</a>(pInstances, NUM_INSTANCES);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Start tuning thread for each instance</span></div>
<div class="line">    pthread_create(&amp;packetProcessHandles[0], NULL, tuningPacketThread, NULL);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 1; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">    {</div>
<div class="line">        pthread_create(&amp;packetProcessHandles[i], NULL, packetProcessThread, pInstances[i]); </div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Start audio pump for all instances</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">    {</div>
<div class="line">        sem_init(&amp;pumpSems[i], 0, 0);</div>
<div class="line">        pthread_create(&amp;audioPumpAllThreadHandles[i], NULL, aweuser_pumpAudio, pInstances[i]);</div>
<div class="line">    }    </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (LOAD_MULTICORE_AWB)</div>
<div class="line">    {</div>
<div class="line">        UINT32 position;</div>
<div class="line">        INT32 ret = <a name="a47"></a><a class="code" href="a00044.html#aab1dea09d71a8da65f245174da6d594e">awe_loadAWBfromArray</a>(pInstances[0], loopback_dualcore_startAudio_InitCommands, loopback_dualcore_startAudio_InitCommands_Len, &amp;position);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != <a class="code" href="a00047.html#ad1a31c5316d5f51ca5c1c4fb2b9b1958">E_SUCCESS</a>)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Error loading awb: error = %d, at offset %u\n&quot;</span>, ret, position);</div>
<div class="line">            exit(1);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> </div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Loaded multi-instance awb\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Close it all down once ready</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">    {</div>
<div class="line">        pthread_join(packetProcessHandles[i], NULL);</div>
<div class="line">        pthread_join(audioPumpAllThreadHandles[i], NULL);</div>
<div class="line">    }    </div>
<div class="line">    </div>
<div class="line">    free(audioInputBuffer);</div>
<div class="line">    free(audioOutputBuffer);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_INSTANCES; i++)</div>
<div class="line">    {</div>
<div class="line">        free(pInstances[i]-&gt;pFastHeapA);</div>
<div class="line">        free(pInstances[i]-&gt;pFastHeapB);</div>
<div class="line">        free(pInstances[i]-&gt;pSlowHeap);</div>
<div class="line">        free((<span class="keywordtype">void</span>*)pInstances[i]-&gt;pName);</div>
<div class="line">        free(pInstances[i]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="aa00047_html_ab4b51c99066bf10a1db260e1a53ec146"><div class="ttname"><a href="a00047.html#ab4b51c99066bf10a1db260e1a53ec146">E_MULTI_PACKET_WAITING</a></div><div class="ttdeci">#define E_MULTI_PACKET_WAITING</div><div class="ttdoc">Multi-instance packet has been forwarded but has not yet been serviced.</div><div class="ttdef"><b>Definition:</b> Errors.h:383</div></div>
<div class="ttc" id="aa00071_html_a440826c61772cf568281332f76871954"><div class="ttname"><a href="a00071.html#a440826c61772cf568281332f76871954">_AWEInstance::numThreads</a></div><div class="ttdeci">UINT32 numThreads</div><div class="ttdoc">Number of threads supported for multithreaded systems(1-4).</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:175</div></div>
<div class="ttc" id="aa00071_html_afbeef773c955bfda318ca134fa40f03b"><div class="ttname"><a href="a00071.html#afbeef773c955bfda318ca134fa40f03b">_AWEInstance::pFastHeapA</a></div><div class="ttdeci">UINT32 * pFastHeapA</div><div class="ttdoc">Fast heap A.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:53</div></div>
<div class="ttc" id="aa00071_html_a3357ea97cbc3a98ffff830eb586dca32"><div class="ttname"><a href="a00071.html#a3357ea97cbc3a98ffff830eb586dca32">_AWEInstance::pFastHeapB</a></div><div class="ttdeci">UINT32 * pFastHeapB</div><div class="ttdoc">The second fast heap, B .</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:56</div></div>
<div class="ttc" id="aa00044_html_aab1dea09d71a8da65f245174da6d594e"><div class="ttname"><a href="a00044.html#aab1dea09d71a8da65f245174da6d594e">awe_loadAWBfromArray</a></div><div class="ttdeci">INT32 awe_loadAWBfromArray(AWEInstance *pAWE, const UINT32 *pCommands, UINT32 arraySize, UINT32 *pPos)</div><div class="ttdoc">Executes packet commands from an in-memory array.</div></div>
<div class="ttc" id="aa00071_html_a689ac9ee605eeb9517ccfaa15679e71a"><div class="ttname"><a href="a00071.html#a689ac9ee605eeb9517ccfaa15679e71a">_AWEInstance::cbAudioStop</a></div><div class="ttdeci">INT32(* cbAudioStop)(struct _AWEInstance *pAWE)</div><div class="ttdoc">OPTIONAL.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:84</div></div>
<div class="ttc" id="aa00056_html_aa902d2fa9a96414950faa1cd33d02af9a8267a816f0e5d656471666befe047de3"><div class="ttname"><a href="a00056.html#aa902d2fa9a96414950faa1cd33d02af9a8267a816f0e5d656471666befe047de3">Sample32bit</a></div><div class="ttdoc">Data is 32 bit PCM .</div><div class="ttdef"><b>Definition:</b> StandardDefs.h:230</div></div>
<div class="ttc" id="aa00044_html_a20d7c4aef91a7b0e190881efa67d15a7"><div class="ttname"><a href="a00044.html#a20d7c4aef91a7b0e190881efa67d15a7">awe_initPin</a></div><div class="ttdeci">INT32 awe_initPin(IOPinDescriptor *pPin, UINT32 channels, const char *name)</div><div class="ttdoc">Initialize an input or output pin.</div></div>
<div class="ttc" id="aa00044_html_ab2a5f4c7d4228495a3af02cad79b2ee7"><div class="ttname"><a href="a00044.html#ab2a5f4c7d4228495a3af02cad79b2ee7">awe_audioExportSamples</a></div><div class="ttdeci">INT32 awe_audioExportSamples(const AWEInstance *pAWE, void *outSamples, INT32 outStride, INT32 channel, SampleType outType)</div><div class="ttdoc">Export samples to a user buffer from a channel.</div></div>
<div class="ttc" id="aa00071_html_acc5c50b58381b039a7e2044863ba9444"><div class="ttname"><a href="a00071.html#acc5c50b58381b039a7e2044863ba9444">_AWEInstance::fastHeapBSize</a></div><div class="ttdeci">UINT32 fastHeapBSize</div><div class="ttdoc">The fast heap B size.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:67</div></div>
<div class="ttc" id="aa00044_html_a2d5438a02407ecb829c58faa4b2610f8"><div class="ttname"><a href="a00044.html#a2d5438a02407ecb829c58faa4b2610f8">awe_packetProcessMulti</a></div><div class="ttdeci">INT32 awe_packetProcessMulti(AWEInstance *pAWE, BOOL isTuningInstance)</div><div class="ttdoc">Multi-instance Wrapper for tuning packet processing.</div></div>
<div class="ttc" id="aa00071_html_ae210f0425f22de96f25bf36ab14ba88c"><div class="ttname"><a href="a00071.html#ae210f0425f22de96f25bf36ab14ba88c">_AWEInstance::pFlashFileSystem</a></div><div class="ttdeci">AWEFlashFSInstance * pFlashFileSystem</div><div class="ttdoc">DSPC Flash file system instance.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:187</div></div>
<div class="ttc" id="aa00038_html"><div class="ttname"><a href="a00038.html">AWECore.h</a></div><div class="ttdoc">The AWECore API Header File.</div></div>
<div class="ttc" id="aa00071_html_a9cb2adbcdae20532abb84c0c7fc9e318"><div class="ttname"><a href="a00071.html#a9cb2adbcdae20532abb84c0c7fc9e318">_AWEInstance::fundamentalBlockSize</a></div><div class="ttdeci">UINT32 fundamentalBlockSize</div><div class="ttdoc">Base frame size of this instance.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:182</div></div>
<div class="ttc" id="aa00044_html_ac6a2989f2e5575d96ce9cd8baab99207"><div class="ttname"><a href="a00044.html#ac6a2989f2e5575d96ce9cd8baab99207">awe_setProfilingStatus</a></div><div class="ttdeci">INT32 awe_setProfilingStatus(AWEInstance *pAWE, UINT32 status)</div><div class="ttdoc">Enable or disable the profiling ability of the AWE Core.</div></div>
<div class="ttc" id="aa00071_html_ae9532b2425c362e352c24f11c8edd02a"><div class="ttname"><a href="a00071.html#ae9532b2425c362e352c24f11c8edd02a">_AWEInstance::instanceId</a></div><div class="ttdeci">UINT32 instanceId</div><div class="ttdoc">The ID of this instance.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:49</div></div>
<div class="ttc" id="aa00071_html_a04b44d860ec9755b807ff1c1e5769fbd"><div class="ttname"><a href="a00071.html#a04b44d860ec9755b807ff1c1e5769fbd">_AWEInstance::pInputPin</a></div><div class="ttdeci">IOPinDescriptor * pInputPin</div><div class="ttdoc">A BSP author must define/allocate an input pin in their BSP and assign it to this member NOTE: AudioW...</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:102</div></div>
<div class="ttc" id="aa00041_html_ac6baaae3417f9751055e0dba298a80a5"><div class="ttname"><a href="a00041.html#ac6baaae3417f9751055e0dba298a80a5">PACKET_LENGTH_BYTES</a></div><div class="ttdeci">#define PACKET_LENGTH_BYTES(x)</div><div class="ttdoc">This will determine the length of a packet in bytes.</div><div class="ttdef"><b>Definition:</b> AWECoreUtils.h:43</div></div>
<div class="ttc" id="aa00071_html_a5b01cf1b8e8a280bbf3f7f948f54f74b"><div class="ttname"><a href="a00071.html#a5b01cf1b8e8a280bbf3f7f948f54f74b">_AWEInstance::pPacketBuffer</a></div><div class="ttdeci">UINT32 * pPacketBuffer</div><div class="ttdoc">The Packet buffer pointer.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:136</div></div>
<div class="ttc" id="aa00044_html_aa14f1cef3b4579e3d0aac85fe9a7c9cd"><div class="ttname"><a href="a00044.html#aa14f1cef3b4579e3d0aac85fe9a7c9cd">awe_layoutIsValid</a></div><div class="ttdeci">INT32 awe_layoutIsValid(const AWEInstance *pAWE)</div><div class="ttdoc">Determines if a layout is loaded and valid.</div></div>
<div class="ttc" id="aa00071_html_aeb7e2d3cb5d35f9704d968e489c4c441"><div class="ttname"><a href="a00071.html#aeb7e2d3cb5d35f9704d968e489c4c441">_AWEInstance::numModules</a></div><div class="ttdeci">UINT32 numModules</div><div class="ttdoc">Number of modules in module table.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:118</div></div>
<div class="ttc" id="aa00071_html_af1ff1dcacc3c9cc819b6f956ce79cf3f"><div class="ttname"><a href="a00071.html#af1ff1dcacc3c9cc819b6f956ce79cf3f">_AWEInstance::pModuleDescriptorTable</a></div><div class="ttdeci">const ModClassModule ** pModuleDescriptorTable</div><div class="ttdoc">Pointer to module table.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:126</div></div>
<div class="ttc" id="aa00044_html_ae4e7e278a5a4794714190415899d8022"><div class="ttname"><a href="a00044.html#ae4e7e278a5a4794714190415899d8022">awe_init</a></div><div class="ttdeci">INT32 awe_init(AWEInstance *pAWE)</div><div class="ttdoc">Initialize the instance.</div></div>
<div class="ttc" id="aa00071_html_ade74518284efdb8fa9e28ea53c832b94"><div class="ttname"><a href="a00071.html#ade74518284efdb8fa9e28ea53c832b94">_AWEInstance::numProcessingInstances</a></div><div class="ttdeci">UINT32 numProcessingInstances</div><div class="ttdoc">The number of audio processing instances of AWE Core configured on a single target.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:199</div></div>
<div class="ttc" id="aa00071_html_af4a2203871c4688499180f87429e3d76"><div class="ttname"><a href="a00071.html#af4a2203871c4688499180f87429e3d76">_AWEInstance::fastHeapASize</a></div><div class="ttdeci">UINT32 fastHeapASize</div><div class="ttdoc">The fast heap A size.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:64</div></div>
<div class="ttc" id="aa00071_html_a6422edfaf98b2c9d2b8e4d61503862c3"><div class="ttname"><a href="a00071.html#a6422edfaf98b2c9d2b8e4d61503862c3">_AWEInstance::cbAudioStart</a></div><div class="ttdeci">INT32(* cbAudioStart)(struct _AWEInstance *PAWE)</div><div class="ttdoc">OPTIONAL This callback is invoked when a layout is run or when a StartAudio command is sent.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:78</div></div>
<div class="ttc" id="aa00044_html_af4b5a0f5f9f869fb6e7ebeccfdd8fae3"><div class="ttname"><a href="a00044.html#af4b5a0f5f9f869fb6e7ebeccfdd8fae3">awe_audioIsStarted</a></div><div class="ttdeci">INT32 awe_audioIsStarted(const AWEInstance *pAWE)</div><div class="ttdoc">Check if this instance is running.</div></div>
<div class="ttc" id="aa00044_html_ab8882c4641a4461678acfab526f61478"><div class="ttname"><a href="a00044.html#ab8882c4641a4461678acfab526f61478">awe_audioGetPumpMask</a></div><div class="ttdeci">INT32 awe_audioGetPumpMask(AWEInstance *pAWE)</div><div class="ttdoc">Test if AWE is ready to run.</div></div>
<div class="ttc" id="aa00071_html_aa69aad6195a0f3fec1e6affcd613b027"><div class="ttname"><a href="a00071.html#aa69aad6195a0f3fec1e6affcd613b027">_AWEInstance::sampleRate</a></div><div class="ttdeci">float sampleRate</div><div class="ttdoc">Default sample rate of this instance.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:178</div></div>
<div class="ttc" id="aa00044_html_acb3df1d67abff15df3f81accf213a379"><div class="ttname"><a href="a00044.html#acb3df1d67abff15df3f81accf213a379">awe_audioIsReadyToPumpMulti</a></div><div class="ttdeci">INT32 awe_audioIsReadyToPumpMulti(AWEInstance *pAWE, UINT32 instanceID)</div><div class="ttdoc">Test if AWE is ready to run on secondary instances (ID &gt; 0).</div></div>
<div class="ttc" id="aa00071_html_ae805783687d93c111f2803d6b07c7d05"><div class="ttname"><a href="a00071.html#ae805783687d93c111f2803d6b07c7d05">_AWEInstance::coreSpeed</a></div><div class="ttdeci">float coreSpeed</div><div class="ttdoc">A BSP author will set this to the speed of the CPU they are integrating into.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:160</div></div>
<div class="ttc" id="aa00044_html_a9e4bb98b017a47c1c1cad5e897c6390b"><div class="ttname"><a href="a00044.html#a9e4bb98b017a47c1c1cad5e897c6390b">awe_audioImportSamples</a></div><div class="ttdeci">INT32 awe_audioImportSamples(const AWEInstance *pAWE, const void *inSamples, INT32 inStride, INT32 channel, SampleType inType)</div><div class="ttdoc">Import samples from a user buffer to a channel.</div></div>
<div class="ttc" id="aa00071_html_a8c37e96abcd68926d0ac6959b5dc6cd6"><div class="ttname"><a href="a00071.html#a8c37e96abcd68926d0ac6959b5dc6cd6">_AWEInstance::slowHeapSize</a></div><div class="ttdeci">UINT32 slowHeapSize</div><div class="ttdoc">The slow heap size.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:70</div></div>
<div class="ttc" id="aa00071_html_a2af7c6f45a9ea471031950713dc8a58d"><div class="ttname"><a href="a00071.html#a2af7c6f45a9ea471031950713dc8a58d">_AWEInstance::pReplyBuffer</a></div><div class="ttdeci">UINT32 * pReplyBuffer</div><div class="ttdoc">Reply buffer pointer.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:145</div></div>
<div class="ttc" id="aa00044_html_a2f78d537ec23c5222d4533de286f6349"><div class="ttname"><a href="a00044.html#a2f78d537ec23c5222d4533de286f6349">awe_deferredSetCall</a></div><div class="ttdeci">INT32 awe_deferredSetCall(AWEInstance *pAWE)</div><div class="ttdoc">Perform deferred awe set on a module.</div></div>
<div class="ttc" id="aa00071_html_ae0ea51f58db3b9d03151fde8bb03574f"><div class="ttname"><a href="a00071.html#ae0ea51f58db3b9d03151fde8bb03574f">_AWEInstance::sharedHeapSize</a></div><div class="ttdeci">UINT32 sharedHeapSize</div><div class="ttdoc">The shared heap size.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:196</div></div>
<div class="ttc" id="aa00050_html"><div class="ttname"><a href="a00050.html">ProxyIDs.h</a></div><div class="ttdoc">A list of all AWE Server Commands.</div></div>
<div class="ttc" id="aa00047_html_ad1a31c5316d5f51ca5c1c4fb2b9b1958"><div class="ttname"><a href="a00047.html#ad1a31c5316d5f51ca5c1c4fb2b9b1958">E_SUCCESS</a></div><div class="ttdeci">#define E_SUCCESS</div><div class="ttdoc">OK result.</div><div class="ttdef"><b>Definition:</b> Errors.h:30</div></div>
<div class="ttc" id="aa00071_html_a1c40d7469bcb0c0b30c35d27ab7a9fb2"><div class="ttname"><a href="a00071.html#a1c40d7469bcb0c0b30c35d27ab7a9fb2">_AWEInstance::profileSpeed</a></div><div class="ttdeci">float profileSpeed</div><div class="ttdoc">Profiling clock speed in Hz.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:163</div></div>
<div class="ttc" id="aa00044_html_a3e08c72e3bf11627e4fd87a99ebb6419"><div class="ttname"><a href="a00044.html#a3e08c72e3bf11627e4fd87a99ebb6419">awe_audioPump</a></div><div class="ttdeci">INT32 awe_audioPump(AWEInstance *pAWE, UINT32 layoutIndex)</div><div class="ttdoc">Audio pump function.</div></div>
<div class="ttc" id="aa00071_html_aa19cf0c2c0ae9511cfe3625d3f2df53b"><div class="ttname"><a href="a00071.html#aa19cf0c2c0ae9511cfe3625d3f2df53b">_AWEInstance::pSlowHeap</a></div><div class="ttdeci">UINT32 * pSlowHeap</div><div class="ttdoc">The slow heap.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:59</div></div>
<div class="ttc" id="aa00044_html_a7b94cd700b8db15b98c0386192efd50f"><div class="ttname"><a href="a00044.html#a7b94cd700b8db15b98c0386192efd50f">awe_getAverageLayoutCycles</a></div><div class="ttdeci">INT32 awe_getAverageLayoutCycles(AWEInstance *pAWE, UINT32 layoutIdx, UINT32 *averageCycles)</div><div class="ttdoc">Get the average cycles of a running layout, in units of cycles at profileSpeed.</div></div>
<div class="ttc" id="aa00041_html"><div class="ttname"><a href="a00041.html">AWECoreUtils.h</a></div><div class="ttdoc">The AWECore Helper Functions File.</div></div>
<div class="ttc" id="aa00071_html_ab8f2f163ae5569e16a4a99070037741c"><div class="ttname"><a href="a00071.html#ab8f2f163ae5569e16a4a99070037741c">_AWEInstance::pSharedHeap</a></div><div class="ttdeci">volatile UINT32 * pSharedHeap</div><div class="ttdoc">AWE Core shared memory definitions.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:193</div></div>
<div class="ttc" id="aa00071_html_a147fe9ce7dca2b6bcc3d86ac9b36f025"><div class="ttname"><a href="a00071.html#a147fe9ce7dca2b6bcc3d86ac9b36f025">_AWEInstance::pName</a></div><div class="ttdeci">const char * pName</div><div class="ttdoc">Name of this instance as a string</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:171</div></div>
<div class="ttc" id="aa00071_html"><div class="ttname"><a href="a00071.html">_AWEInstance</a></div><div class="ttdoc">The AWE instance.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:43</div></div>
<div class="ttc" id="aa00041_html_a45fc7eb0345371558e5a7c64a49d37dc"><div class="ttname"><a href="a00041.html#a45fc7eb0345371558e5a7c64a49d37dc">float_to_fract32</a></div><div class="ttdeci">INT32 float_to_fract32(FLOAT32 x)</div><div class="ttdoc">Convert audio data from floating point to Fract32 sample by sample.</div></div>
<div class="ttc" id="aa00071_html_a5612d068da07ac3f25cf34126b0c3ee1"><div class="ttname"><a href="a00071.html#a5612d068da07ac3f25cf34126b0c3ee1">_AWEInstance::pOutputPin</a></div><div class="ttdeci">IOPinDescriptor * pOutputPin</div><div class="ttdoc">A BSP author must define/allocate an output pin in their BSP and assign it to this member NOTE: Audio...</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:108</div></div>
<div class="ttc" id="aa00044_html_a5fd23e753a1360b0ec5112102ea5536f"><div class="ttname"><a href="a00044.html#a5fd23e753a1360b0ec5112102ea5536f">awe_setInstancesInfo</a></div><div class="ttdeci">void awe_setInstancesInfo(AWEInstance **pInstances, INT32 numAweInstancesOnCore)</div><div class="ttdoc">Setup function only intended for systems with multiple AWE Instances in a single core.</div></div>
<div class="ttc" id="aa00041_html_a55fe32a688d8aa99d686274bccb540f9"><div class="ttname"><a href="a00041.html#a55fe32a688d8aa99d686274bccb540f9">PACKET_LENGTH_WORDS</a></div><div class="ttdeci">#define PACKET_LENGTH_WORDS(x)</div><div class="ttdoc">This will determine the length of a packet in words.</div><div class="ttdef"><b>Definition:</b> AWECoreUtils.h:40</div></div>
<div class="ttc" id="aa00071_html_ab625b95dee9149bb1eae3ff92eb53b2f"><div class="ttname"><a href="a00071.html#ab625b95dee9149bb1eae3ff92eb53b2f">_AWEInstance::packetBufferSize</a></div><div class="ttdeci">UINT32 packetBufferSize</div><div class="ttdoc">Packet buffer size.</div><div class="ttdef"><b>Definition:</b> AWEInstance.h:152</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
